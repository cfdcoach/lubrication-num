	PROGRAM GREASELINETHERMEHL
	CHARACTER*1 S,S1,S2
	CHARACTER*16 FILEO
	COMMON /COM1/ENDA,A1,A2,A3,Z,C1,C2,C3,CW
	COMMON /COM2/T0,EDA0/COM3/E1,PH,B,U1,U2,R,CT/COM4/X0,XE
    COMMON /COM5/H2,P2,T2,ROM,HM,FM/COM6/FF
	DATA KT,S1,S2/0,1HY,1Hy/
	DATA FILEO/4HDATA/
	PAI=3.14159265
	Z=0.68
	P0=1.96E8
	N=129
	X0=-4.
	XE=1.4
	W=1.768E5
	E1=2.21E11
	R=0.02
	Us=1.77
	C1=0.37
	C2=0.37
	NZ=5
	CU=0.25
	CT=0.35
	T2=0.0
	FF=0.85
	OPEN(8,FILE=FILEO,STATUS='UNKNOWN')
	WRITE(*,*)'Show the example or not (Y or N)?'
	READ(*,'(A)')S
	IF(S.EQ.S1.OR.S.EQ.S2)THEN
	KT=2
	GOTO 10
	ELSE
	WRITE(*,*)' Temperature is considered or not (Y or N) ?'
	READ(*,'(A)')S
	IF(S.EQ.S1.OR.S.EQ.S2)KT=2
	ENDIF
	WRITE(*,*)'W,US,FF='
	READ(*,*)W,US,FF
	IF(KT.EQ.2)THEN
	WRITE(*,*)'NZ,CU='
	READ(*,*)NZ,CU
	ENDIF
	WRITE(*,*)' Change iteration factors or not (Y or N) ?'
	READ(*,'(A)')S
	IF(S.EQ.S1.OR.S.EQ.S2)THEN
	WRITE(*,*)'C1,C2='
	READ(*,*)C1,C2
	ENDIF
10  CW=N+0.1
	LMAX=ALOG(CW)/ALOG(2.)
	N=2**LMAX+1
	LMIN=(ALOG(CW)-ALOG(SQRT(CW)))/ALOG(2.)
	LMAX=LMIN
	H00=0.0
	W1=W/(E1*R)
	PH=E1*SQRT(0.5*W1/PAI)
	A1=(ALOG(EDA0)+9.67)
	A2=PH/P0
	A3=0.59/(PH*1.E-9)
	T2=0.0
	B=4.*R*PH/E1
	ALFA=Z*A1/P0
	G=ALFA*E1
	U=EDA0*US/(2.*E1*R)
	CC1=SQRT(2.*U)
	AM=2.*PAI*(PH/E1)**2/CC1
	AL=G*SQRT(CC1)
	CW=(PH/E1)*(B/R)
	C3=1.6*(R/B)**2*G**0.6*U**0.7*W1**(-0.13)
	ENDA=B**(2.+1/FF)*(PH/2/EDA0)**(1/FF)/R**(1+1/FF)/Us/(2.+1/FF)
	ENDA=1./ENDA
	U1=0.5*(2.+CU)*U
	U2=0.5*(2.-CU)*U
	CW=-1.13*C3
	WRITE(*,40)
40  FORMAT(2X,'Wait     Please',//)
	CALL SUBAK(N)
	CALL MULTI(N,NZ,KT,LMIN,LMAX,H00)
	H2=H2*1.E-6
    P2=P2*1.E6
	Q=2.*ROM*HM*US
	FM=FM/W
	STOP
	END
	SUBROUTINE MULTI(N,NZ,KT,LMIN,LMAX,H00)
	DIMENSION X(1100),P(1100),H(1100),RO(1100),POLD(1100),EPS(1100),EDA(1100),P0(2200),F(1100),F0(2200),R(1100), R0(2200),G(10),T(22000)
	COMMON /COM1/ENDA,A1,A2,A3,Z,C1,C2,C3,CW/COM6/FF
	COMMON /COMK/K/COMT/LT,T1(1100)/COM3/E1,PH,B,U1,U2,RR,CT
	COMMON /COM5/H2,P2,T2,RM,HM,FM
	DATA MK,IT,KH,NMAX,PAI,G0/0,0,0,1100,3.14159265,1.570796325/
	LT=LMAX
	NX=N
	K=LMIN
	N0=(N-1)/2**(LMIN-1)
	CALL KNDX(K,N,N0,N1,NMAX,DX,X)
	DO 10 I=1,N
	T1(I)=1.0
	IF(ABS(X(I)).GE.1.0)P(I)=0.0
10  IF(ABS(X(I)).LT.1.0)P(I)=SQRT(1.-X(I)*X(I))
12  CALL HREE(N,DX,H00,G0,X,P,H,RO,EPS,EDA,F,0)
	IF(KH.NE.0)GOTO 14
	KH=1
	GOTO 12
14  CALL FZ(N,P,POLD)
	DO 100 L=LMIN,LMAX
	K=L
	G(K)=PAI/2.
	DO 18 I=1,N
	R(I)=0.0
	F(I)=0.0
	R0(N1+I)=0.0
18   F0(N1+I)=0.0
20   KK=2
	CALL ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F,R,0)
	KK=1
	CALL ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F,R,1)
	G(K-1)=G(K)
	DO 24 I=1,N
	IF(I.LT.N)G(K-1)=G(K-1)-0.5*DX*(P(I)+P(I+1))
24  P0(N1+I)=P(I)
	N2=N
	K=K-1
	CALL KNDX(K,N,N0,N1,NMAX,DX,X)
	CALL TRANS(N,N2,P,H,RO,EPS,EDA,R)
	CALL ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F,R,2)
	DO 26 I=1,N
	IF(I.LT.N)G(K)=G(K)+0.5*DX*(P(I)+P(I+1))
26  F(I)=H(I)
	G0=G(K)
	CALL HREE(N,DX,H00,G0,X,P,H,RO,EPS,EDA,F,1)
	DO 28 I=1,N
	R0(N1+I)=R(I)
28  F0(N1+I)=F(I)
	IF(K.NE.1)GOTO 20
	KK=19
	CALL ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F,R,0)
40  DO 42 I=1,N
42  P0(N1+I)=P(I)
	N2=N1
	K=K+1
	CALL KNDX(K,N,N0,N1,NMAX,DX,X)
	G0=G(K)
	DO 50 I=2,N,2
	I1=N1+I
	I2=N2+I/2
	P(I-1)=P0(I2)
	P(I)=P0(I1)+0.5*(P0(I2)+P0(I2+1)-P0(I1-1)-P0(I1+1))
50  IF(P(I).LT.0.0)P(I)=0.
	DO 52 I=1,N
	R(I)=R0(N1+I)
52  F(I)=F0(N1+I)
	CALL HREE(N,DX,H00,G0,X,P,H,RO,EPS,EDA,F,0)
	KK=1
	CALL ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F,R,0)
	IF(K.LT.L)GOTO 40
100 CONTINUE
	MK=MK+1
    CALL ERROP(N,P,POLD,ERP)
	IF(ERP.GT.0.01*C2.AND.MK.LE.12)GOTO 14
	MK=8
	IF(KT.NE.2)GOTO 105
	CALL THERM(NX,NZ,DX,T,P,H)
	CALL ERROM(NX,NZ,T1,T,KT)
	IT=IT+1
    IF(KT.EQ.2.AND.IT.LT.25)GOTO 14
	KT=2
	IF(IT.GE.25)THEN
	WRITE(*,*)'Temperature is not convergent !!!'
	READ(*,*)
	ENDIF
105 IF(MK.GE.10)THEN
	WRITE(*,*)'Pressures are not convergent !!!'
	READ(*,*)
	ENDIF
	FM=FRICT(N,DX,H,P,EDA)
110 FORMAT(6(1X,E12.6))
	DO I=2,N-1
	IF(P(I).GE.P(I-1).AND.P(I).GE.P(I+1))THEN
	HM=H(I)*B*B/RR
	RM=RO(I)
	GOTO 120
	ENDIF
	ENDDO
120 H2=1.E5
	P2=1.E-10
	DO I=1,N
    H(I)=H(I)*B*B*1.E6/RR
	P(I)=P(I)*PH/1.E6
	IF(H(I).LT.H2)H2=H(I)
	IF(P(I).GT.P2)P2=P(I)
    ENDDO
    DO I=1,N
	WRITE(8,110)X(I),P(I),H(I)
	ENDDO
    IF(KT.EQ.2)THEN
	CALL OUPT(NX,NZ,X,T,T2)
	ENDIF
	RETURN
	END
	SUBROUTINE HREE(N,DX,H00,G0,X,P,H,RO,EPS,EDA,F0,KG)
	DIMENSION X(N),P(N),H(N),RO(N),EPS(N),EDA(N),F0(N)
	DIMENSION W(2200)
	COMMON /COM1/ENDA,A1,A2,A3,Z,C1,C2,C3,CW/COMK/K/COMT/LT,T1(1100)
	COMMON /COM2/T0,EDA0,AK0,AK1,AK2,CV,CV1,CV2, RO0,RO1,RO2,S0,D0/COMAK/AK(0:1100)/COM6/FF
	DATA KK,MK1,MK2,NW,PAI1/0,3,0,2200,0.318309886/
	IF(KK.NE.0)GOTO 3
	HM0=C3
3   W1=0.0
	DO 4 I=1,N
4   W1=W1+P(I)
	C3=(DX*W1)/G0
	DW=1.-C3
	IF(K.EQ.1)GOTO 6
	CALL DISP(N,NW,K,DX,P,W)
	GOTO 10
6   WX=W1*DX*ALOG(DX)
	DO 8 I=1,N
	W(I)=WX
	DO 8 J=1,N
	IJ=IABS(I-J)
8   W(I)=W(I)+AK(IJ)*P(J)*DX
10  HMIN=1.E3
	DO 30 I=1,N
	H0=0.5*X(I)*X(I)-PAI1*W(I)
	IF(KG.EQ.1)GOTO 20
	IF(H0+F0(I).LT.HMIN)HMIN=H0+F0(I)
	H(I)=H0
	GOTO 30
20  F0(I)=F0(I)-H00-H0
30  CONTINUE
	IF(KG.EQ.1)RETURN
	H0=H00+HMIN
	IF(KK.NE.0)GOTO 32
	KK=1
	H00=-H0+HM0
32  IF(H0.LE.0.0)GOTO 48
	IF(K.NE.1)GOTO 50
40  MK=MK+1
	IF(MK.LE.MK1)GOTO 50
	IF(MK.GE.MK2)MK=0
	IF(H0+CW*DW.GT.0.0)HM0=H0+CW*DW
	IF(H0+CW*DW.LE.0.0)HM0=HM0*C3
48  H00=HM0-HMIN
50  DO 60 I=1,N
60  H(I)=H00+H(I)+F0(I)
	IT=2**(LT-K)
	DO 100 I=1,N
	II=IT*(I-1)+1
	CT1=((T1(II)-0.455445545)/0.544554455)**S0
	CT2=D0*T0*(T1(II)-1.)
	EDA(I)=EXP(A1*(-1.+(1.+A2*P(I))**Z*CT1))
	RO(I)=(A3+1.34*P(I))/(A3+P(I))+CT2
	EPS(I)=RO(I)*H(I)**(2+1/FF)/ENDA/EDA(I)**(1/FF)
100 CONTINUE
	RETURN
	END
	SUBROUTINE ITER(N,KK,DX,H00,G0,X,P,H,RO,EPS,EDA,F0,R0,KG)
	DIMENSION X(N),P(N),H(N),RO(N),EPS(N),EDA(N),F0(N),R0(N)
	COMMON /COM1/ENDA,A1,A2,A3,Z,C1,C2,C3/COM6/FF/COMAK/AK(0:1100)
	DATA PAI/3.14159265/
	DX1=1./DX
	DX2=DX*DX
	DX3=1./DX2
	DX4=DX1/PAI
	DX5=DX1**(1.0+1/FF)
	DXL=DX*ALOG(DX)
	AK0=DX*AK(0)+DXL
	AK1=DX*AK(1)+DXL
	DO 100 K=1,KK
	RMAX=0.0
	D2=0.5*(EPS(1)+EPS(2))
	D3=0.5*(EPS(2)+EPS(3))
	D5=DX1*(RO(2)*H(2)-RO(1)*H(1))
	D7=DX4*(RO(2)*AK0-RO(1)*AK1)
	PP=0.
	DO 70 I=2,N-1
	D1=D2
	D2=D3
	D4=D5
	D6=D7
	IF(I+2.LE.N)D3=0.5*(EPS(I+1)+EPS(I+2))
	D5=DX1*(RO(I+1)*H(I+1)-RO(I)*H(I))
	D7=DX4*(RO(I+1)*AK0-RO(I)*AK1)
	AB1=(ABS(P(I+1)-P(I)))**(1/FF-1.0)
	AB2=(ABS(P(I)-P(I-1)))**(1/FF-1.0)
	IF(KG.NE.0)GOTO 30
	DD=(D1+D2)*DX3
	IF(DD.LT.0.1*ABS(D6))GOTO 10
	RI=-DX5*(D2*(P(I+1)-P(I))*AB1-D1*(P(I)-P(I-1))*AB2)+D4+R0(I)
	DLDP=-DX3*(D1+D2)+D6
	RI=C1*RI/DLDP
	GOTO 20
10  RI=-DX5*(D2*(P(I+1)-P(I))*AB1-D1*(P(I)-PP)*AB2)+D4+R0(I)
	DLDP=-1/FF*DX5*(2*D1*AB1+D2*AB2)+2.*D6
	RI=C2*RI/DLDP
	IF(I.GT.2.AND.P(I-1)-RI.GT.0.0)P(I-1)=P(I-1)-RI
20  PP=P(I)
	P(I)=P(I)+RI
	IF(P(I).LT.0.0)P(I)=0.0
	IF(K.NE.KK)GOTO 70
	IF(RMAX.LT.ABS(RI).AND.P(I).GT.0.0)RMAX=ABS(RI)
	GOTO 70
30  IF(KG.EQ.2)GOTO 40
	R0(I)=-DX5*(D2*(P(I+1)-P(I))*AB1-D1*(P(I)-P(I-1))*AB2)+D4+R0(I)
	GOTO 70
40	R0(I)=DX5*(D2*(P(I+1)-P(I))*AB1-D1*(P(I)-P(I-1))*AB2)-D4+R0(I)
70  CONTINUE
	IF(KG.NE.0)GOTO 100
	CALL HREE(N,DX,H00,G0,X,P,H,RO,EPS,EDA,F0,0)
100 CONTINUE
	RETURN
	END
	SUBROUTINE DISP(N,NW,KMAX,DX,P1,W)
	DIMENSION P1(N),W(NW),P(2200),AK1(0:50),AK2(0:50)
	COMMON /COMAK/AK(0:1100)
	DATA NMAX,KMIN/2200,1/
	N2=N
	M=3+2*ALOG(FLOAT(N))
	K1=N+KMAX
	DO 10 I=1,N
10  P(K1+I)=P1(I)
	DO 20 KK=KMIN,KMAX-1
	K=KMAX+KMIN-KK
	N1=(N2+1)/2
	CALL DOWNP(NMAX,N1,N2,K,P)
20  N2=N1
	DX1=DX*2**(KMAX-KMIN)
	CALL WI(NMAX,N1,KMIN,KMAX,DX,DX1,P,W)
	DO 30 K=KMIN+1,KMAX
	N2=2*N1-1
	DX1=DX1/2.
	CALL AKCO(M+5,KMAX,K,AK1)
	CALL AKIN(M+6,AK1,AK2)
	CALL WCOS(NMAX,N1,N2,K,W)
	CALL CORR(NMAX,N2,K,M,1,DX1,P,W,AK1)
	CALL WINT(NMAX,N2,K,W)
	CALL CORR(NMAX,N2,K,M,2,DX1,P,W,AK2)
30  N1=N2
	DO 40 I=1,N
40  W(I)=W(K1+I)
	RETURN
	END
	SUBROUTINE DOWNP(NMAX,N1,N2,K,P)
	DIMENSION P(NMAX)
	K1=N1+K-1
	K2=N2+K-1
	DO 10 I=3,N1-2
	I2=2*I+K2
10  P(K1+I)=(16.*P(I2)+9.*(P(I2-1)+P(I2+1))- (P(I2-3)+P(I2+3)))/32.
	P(K1+2)=0.25*(P(K2+3)+P(K2+5))+0.5*P(K2+4)
	P(K1+N1-1)=0.25*(P(K2+N2-2)+P(K2+N2))+ 0.5*P(K2+N2-1)
	RETURN
	END
	SUBROUTINE WCOS(NMAX,N1,N2,K,W)
	DIMENSION W(NMAX)
	K1=N1+K-1
	K2=N2+K
	DO 10 I=1,N1
	II=2*I-1
10  W(K2+II)=W(K1+I)
	RETURN
	END
	SUBROUTINE WINT(NMAX,N,K,W)
	DIMENSION W(NMAX)
	K2=N+K
	DO 10 I=4,N-3,2
	II=K2+I
10  W(II)=(9.*(W(II-1)+W(II+1))-(W(II-3)+W(II+3)))/16.
	I1=K2+2
	I2=K2+N-1
	W(I1)=0.5*(W(I1-1)+W(I1+1))
	W(I2)=0.5*(W(I2-1)+W(I2+1))
	RETURN
	END
	SUBROUTINE CORR(NMAX,N,K,M,I1,DX,P,W,AK)
	DIMENSION P(NMAX),W(NMAX),AK(0:M)
	K1=N+K
	IF(I1.EQ.2)GOTO 20
	DO 10 I=1,N,2
	II=K1+I
	J1=MAX0(1,I-M)
	J2=MIN0(N,I+M)
	DO 10 J=J1,J2
	IJ=IABS(I-J)
10  W(II)=W(II)+AK(IJ)*DX*P(K1+J)
	RETURN
20  DO 30 I=2,N,2
	II=K1+I
	J1=MAX0(1,I-M)
	J2=MIN0(N,I+M)
	DO 30 J=J1,J2
	IJ=IABS(I-J)
30  W(II)=W(II)+AK(IJ)*DX*P(K1+J)
	RETURN
	END
	SUBROUTINE WI(NMAX,N,KMIN,KMAX,DX,DX1,P,W)
	DIMENSION P(NMAX),W(NMAX)
	COMMON /COMAK/AK(0:1100)
	K1=N+1
	K=2**(KMAX-KMIN)
	C=ALOG(DX)
	DO 10 I=1,N
	II=K1+I
	W(II)=0.0
	DO 10 J=1,N
	IJ=K*IABS(I-J)
10  W(II)=W(II)+(AK(IJ)+C)*DX1*P(K1+J)
	RETURN
	END
	SUBROUTINE AKCO(KA,KMAX,K,AK1)
	DIMENSION AK1(0:KA)
	COMMON /COMAK/AK(0:1100)
	J=2**(KMAX-K)
	DO 10 I=0,KA
	II=J*I
10  AK1(I)=AK(II)
	RETURN
	END
	SUBROUTINE AKIN(KA,AK1,AK2)
	DIMENSION AK1(KA),AK2(KA)
	DO 10 I=4,KA-3
10  AK2(I)=(9.*(AK1(I-1)+AK1(I+1))-(AK1(I-3)+AK1(I+3)))/16.
	AK2(1)=(9.*AK1(2)-AK1(4))/8.
	AK2(2)=(9.*(AK1(1)+AK1(3))-(AK1(3)+AK1(5)))/16.
	AK2(3)=(9.*(AK1(2)+AK1(4))-(AK1(2)+AK1(6)))/16.
	DO 20 I=1,KA
20  AK2(I)=AK1(I)-AK2(I)
	DO 30 I=1,KA,2
	I1=I+1
	AK1(I)=0.0
30  IF(I1.LE.KA) AK1(I1)=AK2(I1)
	RETURN
	END
	SUBROUTINE SUBAK(MM)
	COMMON /COMAK/AK(0:1100)
	DO 10 I=0,MM
10  AK(I)=(I+0.5)*(ALOG(ABS(I+0.5))-1.)-(I-0.5)*(ALOG(ABS(I-0.5))-1.)
	RETURN
	END
	FUNCTION FRICT(N,DX,H,P,EDA)
	DIMENSION H(N),P(N),EDA(N)
	COMMON /COM3/E1,PH,B,U1,U2,R,CT
	DATA TAU0/4.E7/
	TP=TAU0/PH
	TE=TAU0/E1
	BR=B/R
	FRICT=0.0
	DO I=1,N
	DP=0.0
	IF(I.LT.N)THEN
	DP=(P(I+1)-P(I))/DX
	TAU=0.5*H(I)*ABS(DP)*(BR/TP)+2.*ABS(U1-U2)*EDA(I)/(H(I)*BR**2*TE)
	FRICT=FRICT+TAU
	ENDIF
	ENDDO
	FRICT=FRICT*DX*B*TAU0
	RETURN
	END
	SUBROUTINE FZ(N,P,POLD)
	DIMENSION P(N),POLD(N)
	DO 10 I=1,N
10  POLD(I)=P(I)
	RETURN
	END
	SUBROUTINE ERROP(N,P,POLD,ERP)
	DIMENSION P(N),POLD(N)
	SD=0.0
	SUM=0.0
	DO 10 I=1,N
	SD=SD+ABS(P(I)-POLD(I))
	POLD(I)=P(I)
10  SUM=SUM+P(I)
	ERP=SD/SUM
	RETURN
	END
	SUBROUTINE KNDX(K,N,N0,N1,NMAX,DX,X)
	DIMENSION X(NMAX)
	COMMON /COM4/X0,XE
	N=2**(K-1)*N0
	DX=(XE-X0)/N
	N=N+1
	N1=N+K
	DO 10 I=1,N
10  X(I)=X0+(I-1)*DX
	RETURN
	END
	SUBROUTINE TRANS(N1,N2,P,H,RO,EPS,EDA,R)
	DIMENSION P(N2),H(N2),RO(N2),EPS(N2),EDA(N2),R(N2)
	DO 10 I=1,N1
	II=2*I-1
	P(I)=P(II)
	H(I)=H(II)
	R(I)=R(II)
	RO(I)=RO(II)
	EPS(I)=EPS(II)
10  EDA(I)=EDA(II)
	RETURN
	END
	SUBROUTINE OUPT(NX,NZ,X,T,T2)
	DIMENSION X(NX),T(NX,NZ)
	DO I=1,NX
	DO K=1,NZ
	T(I,K)=303.*(T(I,K)-1.0)
	IF(T(I,K).GT.T2)T2=T(I,K)
	END DO
	END DO
	WRITE(8,20)NX,NX,NZ
20  FORMAT(15X,' T(1,1)-T(1,',I4,')-T(',I4,',',I2,') ')
	DO I=1,NX
	WRITE(8,30)X(I),(T(I,K),K=1,NZ)
	ENDDO
30  FORMAT(6(1X,E12.6))
	RETURN
	END
	SUBROUTINE ERROM(NX,NZ,T1,T,KT)
	DIMENSION T(NX,NZ),T1(NX)
	KT=2
	ERM=0.
	C1=1./FLOAT(NZ)
	DO 20 I=1,NX
	TT=0.
	DO 10 K=1,NZ
10  TT=TT+T(I,K)
	TT=C1*TT
	ER=ABS((TT-T1(I))/TT)
	IF(ER.GT.ERM)ERM=ER
20  T1(I)=TT
	IF(ERM.LT.0.003)KT=1
	RETURN
	END
	SUBROUTINE THERM(NX,NZ,DX,T,P,H)
	DIMENSION T(NX,NZ),P(NX),H(NX), T1(21),TI(21),TF(21),U(21),DU(21), W(21),EDA(21), RO(21),EDA1(21),EDA2(21),ROR(21),UU(21)
	DATA KK/0/
	IF(KK.NE.0)GOTO 4
	DO 2 K=1,NZ
2   T(1,K)=1.0
4   DO 30 I=2,NX
	KG=0
	DO 8 K=1,NZ
	TF(K)=T(I-1,K)
	IF(KK.NE.0)GOTO 6
	T1(K)=T(I-1,K)
	GOTO 8
6   T1(K)=T(I,K)
8   TI(K)=T1(K)
	P1=P(I)
	H1=H(I)
	DP=(P(I)-P(I-1))/DX
	CALL TBOUD(NX,NZ,I,CC1,CC2,T)
10  CALL EROEQ(NZ,T1,P1,EDA,RO,EDA1,EDA2,KG)
	CALL UCAL(NZ,DX,H1,EDA,RO,ROR,EDA1,EDA2,U,UU,DU,W,DP)
	CALL TCAL(NZ,DX,CC1,CC2,T1,TF,U,W,DU,H1,DP,EDA,RO)
    CALL ERRO(NZ,TI,T1,ETS)
    KG=KG+3
	IF(ETS.GT.1.E-4.AND.KG.LE.50)GOTO 10
	DO 20 K=1,NZ
	ROR(K)=RO(K)
	UU(K)=U(K)
20  T(I,K)=T1(K)
30  CONTINUE
	KK=1
	RETURN
	END
	SUBROUTINE TBOUD(NX,NZ,I,CC1,CC2,T)
	DIMENSION T(NX,NZ)
	CC1=0.
	CC2=0.
	DO 10 L=1,I-1
	DS=1./SQRT(FLOAT(I-L))
	IF(L.EQ.I-1)DS=1.1666667
	CC1=CC1+DS*(T(L,2)-T(L,1))
10  CC2=CC2+DS*(T(L,NZ)-T(L,NZ-1))
	RETURN
	END
	SUBROUTINE ERRO(NZ,T0,T,ETS)
	DIMENSION T0(NZ),T(NZ)
	ETS=0.0
	DO 10 K=1,NZ
	IF(T(K).LT.1.E-5)ETS0=1.
	IF(T(K).GE.1.E-5)ETS0=ABS((T(K)-T0(K))/T(K))
	IF(ETS0.GT.ETS)ETS=ETS0
10  T0(K)=T(K)
	RETURN
	END
	SUBROUTINE EROEQ(NZ,T,P,EDA,RO,EDA1,EDA2,KG)
	DIMENSION T(NZ),EDA(NZ),RO(NZ),EDA1(NZ),EDA2(NZ)
	COMMON /COM1/ENDA,A1,A2,A3,Z,O1,O2,O3
	COMMON /COM2/T0,EDA0,AK,AK1,AK2,CV,CV1,CV2,RO0,RO1,RO2,S0,D0
    COMMON /COM3/E1,PH,B,U1,U2,R,CC/COM6/FF
	DATA A4,A5/0.455445545,0.544554455/
	IF(KG.NE.0)GOTO 20
	B1=(1.+A2*P)**Z
	B2=(A3+1.34*P)/(A3+P)
20  DO 30 K=1,NZ
	EDA(K)=EXP(A1*(-1.+B1*((T(K)-A4)/A5)**S0))
30  RO(K)=1+D0*T0*(T(K)-1.)
	CC1=0.5/(NZ-1.)
	CC2=1./(NZ-1.)
	C1=0.
	C2=0.
	DO 40 K=1,NZ
	IF(K.EQ.1)GOTO 32
	C1=C1+0.5/EDA(K)+0.5/EDA(K-1)
	C2=C2+CC1*((K-1.)/EDA(K)+(K-2.)/EDA(K-1))
32  EDA1(K)=C1*CC2
40  EDA2(K)=C2*CC2
	IF(KG.NE.2)RETURN
	C1=0.
	C2=0.
	C3=0.
	DO 50 K=1,NZ
	IF(K.EQ.1)GOTO 50
	C1=C1+0.5*(RO(K)+RO(K-1))
	C2=C2+0.5*(RO(K)*EDA1(K)+RO(K)*EDA1(K-1))
	C3=C3+0.5*(RO(K)*EDA2(K)+RO(K)*EDA2(K-1))
50  CONTINUE
	B1=12.*CC2*(C1*EDA2(NZ)/EDA1(NZ)-C2)
60  B2=2.*CC2/(U1+U2)*(C1*(U1-U2)/EDA1(NZ)+C3*U1)
	RETURN
	END
	SUBROUTINE UCAL(NZ,DX,H,EDA,RO,ROR,EDA1,EDA2,U,UU,DU,W,DP)
	DIMENSION U(NZ),DU(NZ),W(NZ),ROR(NZ),UU(NZ), EDA(NZ),RO(NZ), EDA1(NZ),EDA2(NZ)
	COMMON /COM2/T0,EDA0,AK,AK1,AK2,CV,CV1,CV2, RO0,RO1,RO2,S0,D0
	COMMON /COM3/E1,PH,B,U1,U2,R,CC
	DATA KK/0/
	IF(KK.NE.0)GOTO 20
	A1=U1
	A2=PH*(B/R)**3/E1
	A3=U2-U1
20  CC1=A2*DP*H
	CC2=CC1*H
	CC3=A3/H
	CC4=1./EDA1(NZ)
	DO 30 K=1,NZ
	U(K)=A1+CC2*(EDA2(K)-CC4*EDA2(NZ)*EDA1(K))+ A3*CC4*EDA1(K)
	IF(U(K).LT.0.0)U(K)=0.
30  DU(K)=CC1/EDA(K)*((K-1.)/(NZ-1.)-CC4*EDA2(NZ))+CC3*CC4/EDA(K)
	A4=B/((NZ-1)*R*DX)
	C1=A4*H
	IF(KK.EQ.0)GOTO 50
	DO 40 K=2,NZ-1
	W(K)=(RO(K-1)*W(K-1)+C1*(RO(K)*U(K)-ROR(K)*UU(K)))/RO(K)
40  CONTINUE
50  KK=1
	RETURN
	END
	SUBROUTINE TCAL(NZ,DX,CC1,CC2,T,TF,U,W,DU,H,DP,EDA,RO)
	DIMENSION T(NZ),TF(NZ),U(NZ),DU(NZ),W(NZ), EDA(NZ),RO(NZ), A(4,21),D(21),AA(2,21)
	COMMON /COM2/T0,EDA0,AK,AK1,AK2,CV,CV1,CV2, RO0,RO1,RO2,S0,D0
	COMMON /COM3/E1,PH,B,U1,U2,R,CC
	DATA KK,CC5,PAI,TAU0/0,0.6666667,3.14159265,4.E7/
	IF(KK.NE.0)GOTO 5
	KK=1
	TAU=TAU0*B*B/(E1*R*R)
	A2=-CV*RO0*E1*B**3/(EDA0*AK*R)
	A3=-E1*PH*B**3*D0/(AK*EDA0*T0*R)
	A4=-(E1*R)**2/(AK*EDA0*T0)
	A5=0.5*R/B*A2
	A6=AK*SQRT(EDA0*R/(PAI*RO1*CV1*U1*E1*AK1*B**3))
	A7=AK*SQRT(EDA0*R/(PAI*RO2*CV2*U2*E1*AK2*B**3))
5   CC3=A6*SQRT(DX)
	CC4=A7*SQRT(DX)
	DZ=H/(NZ-1.)
	DZ1=1./DZ
	DZ2=DZ1*DZ1
	CC6=A3*DP
	DO 10 K=2,NZ-1
	A(1,K)=DZ2+DZ1*A5*RO(K)*W(K)
	A(2,K)=-2.*DZ2+A2*RO(K)*U(K)/DX+CC6*U(K)/RO(K)
	A(3,K)=DZ2-DZ1*A5*RO(K)*W(K)
	AE=ABS(EDA(K)*DU(K))
10  A(4,K)=A4*ABS(DU(K))*AE+A2*RO(K)*U(K)*TF(K)/DX
	A(1,1)=0.
	A(2,1)=1.+2.*DZ1*CC3*CC5
	A(3,1)=-2.*DZ1*CC3*CC5
	A(1,NZ)=-2.*DZ1*CC4*CC5
	A(2,NZ)=1.+2.*DZ1*CC4*CC5
	A(3,NZ)=0.
	A(4,1)=1.+CC1*CC3*DZ1
	A(4,NZ)=1.-CC2*CC4*DZ1
	CALL TRA3(NZ,D,A,AA)
	DO 20 K=1,NZ
20  T(K)=(1.-CC)*T(K)+CC*D(K)
30  CONTINUE
	RETURN
	END
	SUBROUTINE TRA3(N,D,A,B)
	DIMENSION D(N),A(4,N),B(2,N)
	C=1./A(2,N)
	B(1,N)=-A(1,N)*C
	B(2,N)=A(4,N)*C
	DO 10 I=1,N-1
	IN=N-I
	IN1=IN+1
	C=1./(A(2,IN)+A(3,IN)*B(1,IN1))
	B(1,IN)=-A(1,IN)*C
10  B(2,IN)=(A(4,IN)-A(3,IN)*B(2,IN1))*C
	D(1)=B(2,1)
	DO 20 I=2,N
20  D(I)=B(1,I)*D(I-1)+B(2,I)
	RETURN
	END
	BLOCK DATA
	COMMON /COM2/T0,EDA0,AK,AK1,AK2,CV,CV1,CV2, RO0,RO1,RO2,S0,D0
	DATA T0,EDA0,AK,AK1,AK2,CV,CV1,CV2, RO0,RO1,RO2,S0,D0/303.,0.08,0.14,46.,46.,2000.,470.,470.,890.,7850.,7850.,-1.1,-0.00065/
	END
