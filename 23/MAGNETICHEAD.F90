	PROGRAM MAGNETICHEAD
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION P(101,101),H(101,101),X(101),Y(101),F(101,101),QW(101,101)
	DATA AL,B,HM,BETA1,U,EDA,PA/1.25E-3,1.0E-3,1.0E-8,0.01,25.0,1.8060E-5,1.0135E5/
	DATA ALA,ALFA,R,T0,SKEW,PI,AROLL/63.5E-9,0.95024E-4,287.03,293.0,0.0,3.14159265,6.1465303E-6/
	OPEN(8,FILE='FILM.DAT',STATUS='UNKNOWN')
    OPEN(9,FILE='PRESSURE.DAT',STATUS='UNKNOWN')
	OPEN(10,FILE='ERROR.DAT',STATUS='UNKNOWN')
    OPEN(11,FILE='FLUX.DAT',STATUS='UNKNOWN')
	N=101
	M=N
	N1=N-1
	M1=N1
	N2=N1/2+1
	M2=M1/2+1
	UX=U*COS(SKEW*PI/180.)
	UY=U*SIN(SKEW*PI/180.)
	HC=ALA/HM
	ALENDA=6.0*EDA*UX*AL/(HM**2*PA)
	ALENDAY=6.0*EDA*UY*AL/(HM**2*PA)
	DELTA=AL*SIN(ALFA)/HM
	Q=B/AL
	D0=PA*HM/EDA/SQRT(2.0*R*T0)
	CALL SUBH(N,M,M2,N1,M1,DX,DY,AL,ALFA,B,AROLL,HM,DELTA1,X,Y,H)
	CALL SUBPINIT(N,M,N1,M1,HMIN,H,P,F,QW)
	CALL SUBP(N,M,N1,M1,DX,DY,Q,ALENDA,ALENDAY,D0,DR,PA,AL,B,BETA1,PI,AD,HM,ALFA,U,H,P,F,QW)
	CALL OUTPUT(N,M,X,Y,H,P,F,QW)
	STOP
	END
	SUBROUTINE SUBH(N,M,M2,N1,M1,DX,DY,AL,ALFA,B,AROLL,HM,DELTA1,X,Y,H)
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION X(N),Y(M),H(N,M)
	DO I=1,N
	DO J=1,M
	H(I,J)=(1770.0E-9+HM)/HM
	ENDDO
	ENDDO
	DO I=1,0.1*N
	DO J=1,M
	H(I,J)=(114.0E-9+HM)/HM
	ENDDO
	ENDDO
	DO I=0.1*N+1,0.2*N
	DO J=1,M
	H(I,J)=1.0
	ENDDO
	ENDDO
	DO I=0.2*N+1,0.8*N
	DO J=1,0.1*M
	H(I,J)=1.0
	H(I,M-J)=1.0
	ENDDO
	ENDDO
	DO I=0.77*N+1,0.97*N
	DO J=0.4*M,M/2+1
	H(I,J)=1.0
	H(I,M-J)=1.0
	ENDDO
	ENDDO
	DO I=0.85*N+1,0.95*N
	DO J=0.2*M,0.3*M
	H(I,J)=1.0
	H(I,M-J)=1.0
	ENDDO
	ENDDO
	X(1)=0.0
	DX=1./N1
	DO I=2,N
	X(I)=X(I-1)+DX
	ENDDO
	Y(1)=-0.5
	DY=1./M1
	DO J=2,M
	Y(J)=Y(J-1)+DY
	ENDDO
	X(N)=1.0
	Y(M2)=0.0
	HMIN=10.0
	DO I=1,N
	DO J=1,M
	DELTA1=(AL*(X(N)-X(I))*SIN(ALFA)+B*(Y(M)-Y(J))*SIN(AROLL))/HM
	H(I,J)=H(I,J)+DELTA1
	IF(H(I,J).LT.HMIN)THEN
	IMIN=I
	JMIN=J
	HMIN=H(I,J)
	ENDIF
	ENDDO
	ENDDO
	RETURN
	END
	SUBROUTINE SUBPINIT(N,M,N1,M1,HMIN,H,P,F,QW)
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION H(N,M),P(N,M),F(N,M),QW(N,M)
	DO I=1,N
	DO J=1,M
	P(I,J)=1.0
	F(I,J)=0.0
	QW(I,J)=1.0
	ENDDO
	ENDDO
	DO I=2,N1
	DO J=2,M1
	P(I,J)=P(I-1,J)*H(I-1,J)/H(I,J)
	ENDDO
	ENDDO
	RETURN
	END
	SUBROUTINE SUBP(N,M,N1,M1,DX,DY,Q,ALENDA,ALENDAY,D0,DR,PA,AL,B,BETA1,PI,AD,HM,ALFA,U,H,P,F,QW)		
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION H(N,M),P(N,M),F(N,M),QW(N,M)
	K=0
	DX1=1./DX
	DY1=1./(Q*DY)
	DX2=DX1*DX1
	DY2=DY1*DY1
	CX=2.*ALENDA*DX1
	CY=2.*ALENDAY*DY1
10	DO I=1,N
	DO J=1,M
	DR=D0*P(I,J)*H(I,J)
    QC=DR/6.0
	QP=QC+1.0162+0.40134*DLOG(1.0+1.2477/DR)
	QW(I,J)=QP/QC
	ENDDO
	ENDDO
	ERR=0.0
	DO J=2,M1
	DO I=2,N1
	C0=CX*H(I,J)
	C5=CX*P(I-1,J)*H(I-1,J)
	CY0=CY*H(I,J)
	CY5=CY*P(I,J-1)*H(I,J-1)
	TMP1 = QW(I+1,J)*H(I+1,J)*H(I+1,J)*H(I+1,J)
	TMP2 = QW(I,J)*H(I,J)*H(I,J)*H(I,J)
	QHP1 = 2.0*TMP1*TMP2/(TMP1+TMP2)
	TMP1 = QW(I-1,J)*H(I-1,J)*H(I-1,J)*H(I-1,J)
	QHM1 = 2.0*TMP1*TMP2/(TMP1+TMP2)
	C1=P(I,J)*(QHP1+ QHM1)*DX2
	C3=(P(I+1,J)*P(I+1,J)*QHP1+P(I-1,J)*P(I-1,J)*QHM1)*DX2
	TMP1 = QW(I,J+1)*H(I,J+1)*H(I,J+1)*H(I,J+1)
	QHP1 = 2.0*TMP1*TMP2/(TMP1+TMP2)
	TMP1 = QW(I,J-1)*H(I,J-1)*H(I,J-1)*H(I,J-1)
	QHM1 = 2.0*TMP1*TMP2/(TMP1+TMP2)
	C2=P(I,J)*(QHP1+ QHM1)*DY2
	C4=(P(I,J+1)*P(I,J+1)*QHP1+P(I,J-1)*P(I,J-1)*QHM1)*DY2
	TMP=(C5+C3+C4+CY5)/(C0+C1+C2+CY0)
	P(I,J)=P(I,J)+ BETA1*(TMP-P(I,J))
	F(I,J)=P(I,J)*(C0+C1+C2+CY0)-C3-C4-C5-CY5
	IF(ABS(F(I,J)).GT.ERR)ERR=ABS(F(I,J))
	ENDDO
	ENDDO
	K=K+1
	WRITE(*,*)'K=, ERR=',K,ERR
	IF(ERR.LT.1.E-5)GOTO 20
	IF(K.GT.500)BETA1=0.1
	IF(K.GT.2000)BETA1=0.5
	IF(K.GT.3000)BETA1=0.75
	IF(K.GT.5000)BETA1=0.95
	IF(K.LE.8000) GOTO 10
20	SM=0.0
	PMAX=0.0
	PMIN=0.0
	AD=2.0/SQRT(PI)
	DO I=1,N
	DO J=1,M
	P(I,J)=P(I,J)-1.
	SM=SM+P(I,J)
	IF(P(I,J).GT.PMAX)THEN
	PMAX=P(I,J)
	IMAX=I
	JMAX=J
	ENDIF
	IF(P(I,J).LT.PMIN)THEN
	PMIN=P(I,J)
	IMIN=I
	JMIN=J
	ENDIF
	QW(I,J)=AD*D0*(1.+P(I,J))*H(I,J)
	H(I,J)=HM*H(I,J)
	ENDDO
	ENDDO
	SM=SM*PA*AL*B/(N1*M1)
	WRITE(*,*)'ALFA=',ALFA,'HM=',HM,'U=',U,'LOAD=',SM,'PMAX=',PMAX,'PMIN=',PMIN
	RETURN
	END
	SUBROUTINE OUTPUT(N,M,X,Y,H,P,F,QW)
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION X(N),Y(M),H(N,M),P(N,M),F(N,M),QW(N,M)
	WRITE(8,30)(Y(J),J=1,M)
30	FORMAT(1X,101(E12.6,1X))
	WRITE(8,40)(X(I),(H(I,J),J=1,M),I=1,N)
40	FORMAT(102(E12.6,1X))
	WRITE(9,30)(Y(J),J=1,M)
	WRITE(9,40)(X(I),(P(I,J),J=1,M),I=1,N)
	WRITE(10,30)(Y(J),J=1,M)
	WRITE(10,40)(X(I),(F(I,J),J=1,M),I=1,N)
	WRITE(11,30)(Y(J),J=1,M)
	WRITE(11,40)(X(I),(QW(I,J),J=1,M),I=1,N)
	RETURN
	END
