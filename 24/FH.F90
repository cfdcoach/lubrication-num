	PROGRAM FH
	IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION P(161,161),H(161,161),X(161),Y(161),PP0(161,161),HH0(161,161)
	DIMENSION H0(161,161),QPH3(161,161),HHH(161,161),A(3,4)
	REAL*8 L21,L31,L32,M22,M23,M24
	DATA BETA1/0.01/,R/287.03/,T0/293.0/,PI/3.14159265/,EDA/1.806E-5/,PA/1.0136E5/,ALA/63.5E-9/
	DATA B/0.7/,AL/1.235/,CR/17.561/,RPM/0.48E4/,SKEW/-14.923/,XHR/1.21/,YHR/0./,H00/6.0/,ALFA0/50.0/,BETA/0./
	DATA XC/0.6175/,YC/0./,W0/1.5/,AM0/0.867/,BM0/0./
	KG=0
	KL=0     
	KG1=0    
	KG2=0 
	AL=AL*1.0E-3
	B=B*1.0E-3
	ALFA0=ALFA0*1.0E-6
	BETA=BETA*1.0E-6
	H00=H00*1.0E-9
	XCD=XC*1.0E-3/AL
	YCD=YC*1.0e-3/B
	U=2*PI*CR*RPM/60.E3
	N1=161  
	M1=N1
	N=N1-1
	N2=N/2+1
	M=M1-1
	M2=M/2+1
	UX=U*COS(SKEW*PI/180.)
	UY=U*SIN(SKEW*PI/180.)
	Q=B/AL
	AD=2.0/SQRT(3.14159265)
	DX=1./N
	DY=DX
	DX1=1./DX
	DY1=1./(Q*DY)
	DX2=DX1*DX1     
	DY2=DY1*DY1
	SPA=PA/(EDA*SQRT(2.0*R*T0))
	ALENDA0=6.0*EDA*AL/PA
	CW=PA*AL*B/(N*M)
	CM=PA*AL**2*B/(N*M)
	CMR=PA*B**2*AL/(N*M)
	READ(20,3)X(1),(Y(J),J=1,161)
	DO I=1,161
	READ(20,3)X(I),(H0(I,J),J=1,161)
	ENDDO
3	FORMAT(162(E12.6,1X))
	IF(SKEW.LT.0)THEN           
	UY=ABS(UY)
	BM0=-1.*BM0
	DO I=1,N1
	DO J=1,M1
	QPH3(I,J)=H0(I,162-J)
	ENDDO
	ENDDO
	DO I=1,N1
	DO J=1,M1
	H0(I,J)=QPH3(I,J)
	ENDDO
	ENDDO
	ENDIF
	X(1)=0.0
	DO I=2,N1
	X(I)=X(I-1)+DX
	ENDDO
	Y(1)=-0.5
	DO J=2,M1
	Y(J)=Y(J-1)+DY
	ENDDO
	Y(M2)=0.0
	X0=0.0      
	AM=0.0      
	H1=H00
	ALFA=ALFA0
	SDH=3.0E-9     
	SDALFA=20.E-6
	SDBETA=5.E-6
	XHR=XHR*1.0e-3/AL
	YHR=YHR*1.0e-3/B
	DO I=1,N1                                    
	IF(ABS(XHR/DX-I).LT.0.5)IXHR=I
	ENDDO
	DO J=1,M1
	IF(ABS(YHR-Y(J)).LT.(DY/2))JYHR=J
	ENDDO
1	IF(KG2==0)THEN
	K=0
	BETA1=0.01
	ENDIF
	IF(KG2==1)THEN
	K=1000
	BETA1=0.75
	ENDIF
	H2=H1*H1
	ALENDAX=ALENDA0*UX/H2      
	ALENDAY=ALENDA0*UY/H2      
	SALFA=AL*SIN(ALFA)
	SBETA=B*SIN(BETA)
	D0=SPA*H1
	HMIN=10.0
	DO I=1,N1
	DO J=1,M1
    H(I,J)=((H0(I,J)-H0(IXHR,JYHR))/COS(ALFA)/COS(BETA)+(X(IXHR)-X(I))*SALFA+(Y(J)-Y(JYHR))*SBETA)/H1+1.0
	IF(H(I,J).LT.0.0)THEN
	H1=1.5*H1
	ALFA=8.E-5
	WRITE(*,*)'H1 was forced to multiply by 1.5 automatically To avoid negative film thickness dots '
	GOTO 1
	ENDIF
	HHH(I,J)=H(I,J)*H(I,J)*H(I,J)
	IF(KG1.EQ.0)THEN
	P(I,J)=1.0
	ENDIF
	ENDDO
	ENDDO
	IF(KG1.EQ.0)THEN
	KG1=1
	DO I=2,N
	DO J=2,M
	P(I,J)=P(I-1,J)*H(I-1,J)/H(I,J)
	ENDDO
	ENDDO
	ENDIF
10	DO I=1,N1
	DO J=1,M1
	DR=D0*P(I,J)*H(I,J)
	QC=DR/6.0
	QP= 1.720805*DR**(-0.25953)+3.173598*SQRT(3.14159265)/2.+QC
	QPH3(I,J)=P(I,J)*QP*HHH(I,J)/QC
	ENDDO
	ENDDO
	ERR=0.0  
	DO J=2,M
	J1=J-1
	J2=J+1
	DO I=2,N
	I1=I-1
	I2=I+1
	HX1=(H(I,J)+H(I1,J))/2.                   
    HX2=(H(I,J)+H(I2,J))/2.
	HY1=(H(I,J)+H(I,J1))/2.
	HY2=(H(I,J)+H(I,J2))/2.
	FW=ALENDAX*HX1
	FE=ALENDAX*HX2
	FN=ALENDAY*HY2/Q
	FS=ALENDAY*HY1/Q
	TMP=QPH3(I,J)
	TMP1=QPH3(I2,J)
	QHP1=2.*DX1*TMP*TMP1/(TMP+TMP1)
	PL1=FE/QHP1
	CE=QHP1*MAX(0.,(1.0-0.1*PL1)**5)
	TMP1=QPH3(I1,J)
	QHM1=2.*DX1*TMP*TMP1/(TMP+TMP1)
	PL1=FW/QHM1
	CWW=QHM1*MAX(0.,(1.0-0.1*PL1)**5)
	TMP1=QPH3(I,J2)
	QHP1=2.*TMP*TMP1/(TMP+TMP1)/(DY*Q**2)
	PL1=FN/QHP1
	CN=QHP1*MAX(0.,(1.0-0.1*PL1)**5)
	TMP1=QPH3(I,J1)
	QHM1=2.*TMP*TMP1/(TMP+TMP1)/(DY*Q**2)
    PL1=FS/QHM1
	CS=QHM1*MAX(0.,(1.0-0.1*PL1)**5)
	TMP1=CE*P(I2,J)+(CWW+FW)*P(I1,J)+CN*P(I,J2)+(CS+FS)*P(I,J1)
	TMP2=CE+CWW+CN+CS+FE+FN
	P(I,J)=P(I,J)+BETA1*(TMP1/TMP2-P(I,J))
	F=P(I,J)*TMP2-TMP1
	IF(ABS(F).GT.ERR)ERR=ABS(F)
	ENDDO
	ENDDO
	K=K+1
	IF(ERR.LT.10.)GOTO 20
	IF(K.GT.300)BETA1=0.1
	IF(K.GT.600)BETA1=0.5
	IF(K.GT.1000)BETA1=0.75
	IF(K.GT.1500)BETA1=0.95
	IF(K.GT.2000)BETA1=1.1
	IF(K.GT.2500)BETA1=1.2
	IF(K.GT.3000)BETA1=1.25
	IF(K.GT.15000)BETA1=0.95
	WRITE(*,*)'K=',K,'     ERR=',ERR
	IF(ERR.GT.20.AND.K.LE.18000)GOTO 10
20 	W=0.0
	AM=0.0
	BM=0.0
	DO I=1,N1
	DO J=1,M1
	W=W+P(I,J)-1.0
	AM=AM+(P(I,J)-1.0)*(X(I)-XCD)  
	BM=BM+(P(I,J)-1.0)*(Y(J)-YCD)   
	ENDDO
	ENDDO
	WRITE(*,*) K,ERR
	W=W*CW
	AM=AM*CM
	BM=BM*CMR
    IF(KL.EQ.1) THEN
	KL=0
	WP=(W-W00)*1.E3/9.80665
	PP=(AM-AM00)*1.0E6 
	RP=(BM-BM00)*1.0E6   
	W=W00
	AM=AM00
	BM=BM00
	ALFA=ALFA-1.0E-6
	H1=H1+(AL-XC*1.0E-3)*1.0E-6
	DO I=1,161
	DO J=1,161
	P(I,J)=PP0(I,J)
	H(I,J)=HH0(I,J)
	ENDDO
	ENDDO
	WRITE(*,*)
	WRITE(*,*)'stiffness_Matrix:'
	WRITE(*,'(A15,3(A12,1X))')'       £Ü      ','  H(nm)  ','PITCH(urad)','ROLL(urad)'
	WRITE(*,21) 'W(g)        ',WH,WP,WR
	WRITE(*,21) 'P-TORQUE(uNm)',PH,PP,PR
	WRITE(*,21) 'R-TORQUE(uNm)',RH,RP,RR
	WRITE(*,*)
	GOTO 29
    ENDIF
	IF(KG2.EQ.0) THEN
	DW=W0-W*1.E3/9.80665
	DM=AM0-AM*1.E6
	DMR=BM0-BM*1.E6
	WRITE(*,21)'H1_ALFA_BETA:',H1,ALFA,BETA
	WRITE(*,21)'DW_DM_DMR:   ',DW,DM,DMR
21  FORMAT(A15,1X,3(ES13.6,3X))
	IF(ABS(DW)/W0.LT.0.01.AND.ABS(DM)/AM0.LT.0.01.AND.ABS(DMR).LT.0.02) THEN 
	DO I=1,161
	DO J=1,161
	PP0(I,J)=P(I,J)
	HH0(I,J)=H(I,J)
	ENDDO
	ENDDO
	W00=W
	AM00=AM
	BM00=BM
	ALFA=ALFA+1.0E-6
	H1=H1-(AL-XC*1.0E-3)*1.0E-6
	KL=1                            
	GOTO 1
	ENDIF
	IF(ABS(DW).LT.0.5.AND.ABS(DM).LT.1.0.AND.ABS(DMR).LT.0.5)THEN
	SDH=1.0E-9         
	SDALFA=5.0E-6
	SDBETA=2.0E-6
	ENDIF
	IF(ABS(DW).LT.0.1.AND.ABS(DM).LT.0.1.AND.ABS(DMR).LT.0.1)THEN
	SDH=1.E-9         
	SDALFA=5.0E-6
	SDBETA=5.0E-6
	ENDIF
	WRITE(*,21)'SDH_AFA_BTA',SDH,SDALFA,SDBETA
	W00=W
	AM00=AM
	BM00=BM
	KG2=1
   	ENDIF
	IF(KG.EQ.0)THEN
	KG=1
	H1=H1+SDH
	GOTO 1
	ENDIF
	IF(KG.EQ.1)THEN
	KG=2
	WH=(W-W00)*1.E3/9.80665/(SDH*1.E9) 
	PH=(AM-AM00)*1.E-3/SDH
	RH=(BM-BM00)*1.E-3/SDH 
	ALFA=ALFA+SDALFA
	H1=H1-SDH
	GOTO 1
	ENDIF
	IF(KG.EQ.2)THEN
	KG=3
	WP=(W-W00)*1.E-3/9.80665/SDALFA  
	PP=(AM-AM00)/SDALFA  
	RP=(BM-BM00)/SDALFA      
	BETA=BETA+SDBETA
	ALFA=ALFA-SDALFA
	GOTO 1
	ENDIF
	IF(KG.EQ.3)THEN
	WR=(W-W00)*1.E-3/9.80665/SDBETA  
	PR=(AM-AM00)/SDBETA 
	RR=(BM-BM00)/SDBETA
	ENDIF
	WRITE(*,*)'stiffness_Matrix:'
	WRITE(*,'(A15,3(A12,1X))')'       £Ü      ','  H(nm)  ','PITCH(urad)','ROLL(urad)'
    WRITE(*,21) 'W(g)        ',WH,WP,WR
	WRITE(*,21) 'P-TORQUE(uNm)',PH,PP,PR
	WRITE(*,21) 'R-TORQUE(uNm)',RH,RP,RR
	BETA=BETA-SDBETA
	A(1,1)=MAX(WH,PH,RH)
	IF(ABS(A(1,1)-WH).LT.1.0E-6)THEN
	A(1,2)=WP
	A(1,3)=WR
	A(1,4)=DW
	L21=PH/WH
	A(2,1)=0.0
	A(2,2)=PP-L21*WP
	A(2,3)=PR-L21*WR
	A(2,4)=DM-L21*DW
	L31=RH/WH
	A(3,1)=0.0
	A(3,2)=RP-L31*WP
	A(3,3)=RR-L31*WR
	A(3,4)=DMR-L31*DW
	ELSE IF(ABS(A(1,1)-PH).LT.1.0E-6)THEN
	A(1,1)=PH
	A(1,2)=PP
	A(1,3)=PR
	A(1,4)=DM
	L21=WH/PH
	A(2,1)=0.0
	A(2,2)=WP-L21*PP
	A(2,3)=WR-L21*PR
	A(2,4)=DW-L21*DM
	L31=RH/PH
	A(3,1)=0.0
	A(3,2)=RP-L31*PP
	A(3,3)=RR-L31*PR
	A(3,4)=DMR-L31*DM
	ELSE
	A(1,1)=RH
	A(1,2)=RP
	A(1,3)=RR
	A(1,4)=DMR
	L21=PH/RH
	A(2,1)=0.0
	A(2,2)=PP-L21*RP
	A(2,3)=PR-L21*RR
	A(2,4)=DM-L21*DMR
	L31=WH/RH
	A(3,1)=0.0
	A(3,2)=WP-L31*RP
	A(3,3)=WR-L31*RR
	A(3,4)=DW-L31*DMR
	ENDIF
	W22=MAX(A(2,2),A(3,2))
	IF(ABS(W22-A(2,2)).LT.1.0E-6)THEN
	L32=A(3,2)/A(2,2)
	A(3,2)=0.0
	A(3,3)=A(3,3)-L32*A(2,3)
	A(3,4)=A(3,4)-L32*A(2,4)
	ELSE
	L32=A(2,2)/A(3,2)
	M22=A(3,2)
	M23=A(3,3)
	M24=A(3,4)
	A(3,2)=0.0
	A(3,3)=A(2,3)-L32*A(3,3)
	A(3,4)=A(2,4)-L32*A(3,4)
	A(2,2)=M22
	A(2,3)=M23
	A(2,4)=M24
	ENDIF
	DBETA=A(3,4)/A(3,3)
	DALFA=(A(2,4)-A(2,3)*DBETA)/A(2,2)
	DH=(A(1,4)-A(1,2)*DALFA-A(1,3)*DBETA)/A(1,1)
	ERRDW=ABS(WH*DH+WP*DALFA+WR*DBETA-DW)
	ERRDM=ABS(PH*DH+PP*DALFA+PR*DBETA-DM)
	ERRDMR=ABS(RH*DH+RP*DALFA+RR*DBETA-DMR)
	WRITE(*,21)' Equation_Err:      ',ERRDW,ERRDM,ERRDMR
	WRITE(*,21)'Revise_Atti_P',DH,DALFA,DBETA
	KG=0
	KG2=0
	H1=H1+DH*1.0E-9
	IF(H1.LE.0)THEN
	H1=1.E-8
	WRITE(*,*)'H1 was revised from a negetive value to 10nm '
	ENDIF
	ALFA=ALFA+DALFA*1.0E-6
	IF(ALFA.LE.0)THEN 
	ALFA=8.E-5
	WRITE(*,*)'ALFA was revised from a negetive value to 80urad '
	ENDIF
	BETA=BETA+DBETA*1.0E-6
	WRITE(*,*)'**************'
	GOTO 1
29	X0=AM/W+XCD*AL
	Y0=BM/W+YCD*B
	PMAX=0.0
	PMIN=0.0
	IF(SKEW.LT.0)THEN           
	BM=-1.*BM
	Y0=-1.*Y0
	BETA=-1.*BETA
	RH=-1.*RH
	RP=-1.*RP
	WR=-1.*WR
	PR=-1.*PR
	DO I=1,N1
	DO J=1,M1
	QPH3(I,J)=H(I,162-J)
	HHH(I,J)=P(I,162-J)
	ENDDO
	ENDDO
	DO I=1,N1
	DO J=1,M1
	H(I,J)=QPH3(I,J)
	P(I,J)=HHH(I,J)
	ENDDO
	ENDDO
	ENDIF
	DO I=1,N1
	DO J=1,M1
	P(I,J)=P(I,J)-1.0
	IF(P(I,J).GT.PMAX)PMAX=P(I,J)
	IF(P(I,J).LT.PMIN)PMIN=P(I,J)
	H(I,J)=H1*H(I,J)
	ENDDO
	ENDDO
	OPEN(8,FILE='FILM.DAT',STATUS='UNKNOWN')
	OPEN(9,FILE='PRESSURE.DAT',STATUS='UNKNOWN')
	WRITE(8,30)Y(1),(Y(J),J=1,M1)
30	FORMAT(162(E12.6,1X))
	WRITE(8,40)(X(I),(H(I,J),J=1,M1),I=1,N1)
40	FORMAT(162(E12.6,1X))
	WRITE(9,30)Y(1),(Y(J),J=1,M1)
	WRITE(9,40)(X(I),(P(I,J),J=1,M1),I=1,N1)
50	FORMAT(161(E12.6,1X))
	H1=H1*1.0E9
	ALFA=ALFA*1.0E6
	BETA=BETA*1.0E6
	W=W*1.0E3/9.80665
	AM=AM*1.0E6
	BM=BM*1.0E6
	X0=X0*1.0E3
	Y0=Y0*1.0E3
	XHR=XHR*1.0e3*AL
	YHR=YHR*1.0e3*B
 51	FORMAT(30(G12.6,1X))
	OPEN(10,FILE='RESULT.DAT',STATUS='UNKNOWN')
	WRITE(10,*)RPM,CR,SKEW,U,XC,YC,W0,AM0,BM0,PMAX,PMIN,W,AM,BM,X0,Y0,H1,XHR,YHR,ALFA,BETA,WH,WP,WR,PH,PP,PR,RH,RP,RR
	STOP
	END
